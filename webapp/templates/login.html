{% extends "base.html" %}

{% block title %}Sign In - Parkinson's Disease Detection{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-card">
        <!-- Brand -->
        <div class="auth-brand">
            <div class="brain-icon"><i class="fas fa-brain" style="margin:0"></i></div>
            <h4>PD Detection System</h4>
            <p>Secure access to Parkinson's analysis</p>
        </div>

        <!-- Tabs (using addEventListener, no onclick) -->
        <div class="auth-tabs">
            <button class="tab-btn active" id="loginTab" type="button">Sign In</button>
            <button class="tab-btn" id="registerTab" type="button">Create Account</button>
        </div>

        <!-- Alert -->
        <div id="authAlert" class="auth-alert" role="alert"></div>

        <!-- Login pane -->
        <div class="auth-pane active" id="loginPane">
            <form id="loginForm" novalidate>
                <div class="mb-3">
                    <label for="loginEmail">Email</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-envelope" style="margin:0"></i></span>
                        <input type="email" class="form-control" id="loginEmail" placeholder="you@example.com" required autocomplete="email">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="loginPassword">Password</label>
                    <div class="position-relative">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock" style="margin:0"></i></span>
                            <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
                        </div>
                        <button type="button" class="password-toggle" id="loginPasswordToggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="auth-btn" id="loginBtn">
                    <span class="btn-text">Sign In</span>
                </button>
            </form>
            <div class="auth-footer">
                <span>Don't have an account? </span><a href="#" id="switchToRegister">Create one</a>
            </div>
        </div>

        <!-- Register pane -->
        <div class="auth-pane" id="registerPane">
            <form id="registerForm" novalidate>
                <div class="mb-3">
                    <label for="registerEmail">Email</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-envelope" style="margin:0"></i></span>
                        <input type="email" class="form-control" id="registerEmail" placeholder="you@example.com" required autocomplete="email">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="registerPassword">Password</label>
                    <div class="position-relative">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock" style="margin:0"></i></span>
                            <input type="password" class="form-control" id="registerPassword" placeholder="Min 8 characters" required minlength="8" autocomplete="new-password">
                        </div>
                        <button type="button" class="password-toggle" id="registerPasswordToggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <!-- Password strength indicator -->
                    <div class="password-strength" id="passwordStrength">
                        <div class="bar" id="passwordStrengthBar"></div>
                    </div>
                    <small id="passwordStrengthText" style="color:var(--text-3);font-size:.72rem"></small>
                </div>
                <div class="mb-3">
                    <label for="registerConfirm">Confirm Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-shield-alt" style="margin:0"></i></span>
                        <input type="password" class="form-control" id="registerConfirm" placeholder="Repeat password" required autocomplete="new-password">
                    </div>
                </div>
                <button type="submit" class="auth-btn" id="registerBtn">
                    <span class="btn-text">Create Account</span>
                </button>
            </form>
            <div class="auth-footer">
                <span>Already have an account? </span><a href="#" id="switchToLogin">Sign in</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    'use strict';

    // Redirect if already logged in
    if (localStorage.getItem('access_token')) { window.location.href = '/'; return; }

    var authAlert = document.getElementById('authAlert');

    // --- Tab switching via addEventListener (accessibility fix) ---
    function switchTab(tab) {
        document.getElementById('loginPane').classList.toggle('active', tab === 'login');
        document.getElementById('registerPane').classList.toggle('active', tab === 'register');
        document.getElementById('loginTab').classList.toggle('active', tab === 'login');
        document.getElementById('registerTab').classList.toggle('active', tab === 'register');
        hideAlert();
    }

    document.getElementById('loginTab').addEventListener('click', function () { switchTab('login'); });
    document.getElementById('registerTab').addEventListener('click', function () { switchTab('register'); });
    document.getElementById('switchToRegister').addEventListener('click', function (e) { e.preventDefault(); switchTab('register'); });
    document.getElementById('switchToLogin').addEventListener('click', function (e) { e.preventDefault(); switchTab('login'); });

    // --- Password toggle via addEventListener ---
    function togglePassword(inputId, btn) {
        var input = document.getElementById(inputId);
        var icon = btn.querySelector('i');
        if (input.type === 'password') { input.type = 'text'; icon.className = 'fas fa-eye-slash'; }
        else { input.type = 'password'; icon.className = 'fas fa-eye'; }
    }
    document.getElementById('loginPasswordToggle').addEventListener('click', function () { togglePassword('loginPassword', this); });
    document.getElementById('registerPasswordToggle').addEventListener('click', function () { togglePassword('registerPassword', this); });

    // --- Password strength indicator ---
    var pwInput = document.getElementById('registerPassword');
    var strengthBar = document.getElementById('passwordStrengthBar');
    var strengthText = document.getElementById('passwordStrengthText');

    pwInput.addEventListener('input', function () {
        var pw = pwInput.value;
        var score = 0;
        if (pw.length >= 8) score++;
        if (pw.length >= 12) score++;
        if (/[a-z]/.test(pw) && /[A-Z]/.test(pw)) score++;
        if (/\d/.test(pw)) score++;
        if (/[^a-zA-Z0-9]/.test(pw)) score++;

        strengthBar.className = 'bar';
        strengthText.textContent = '';

        if (pw.length === 0) return;

        if (score <= 2) {
            strengthBar.classList.add('weak');
            strengthText.textContent = 'Weak';
            strengthText.style.color = 'var(--danger)';
        } else if (score <= 3) {
            strengthBar.classList.add('medium');
            strengthText.textContent = 'Medium';
            strengthText.style.color = 'var(--warning)';
        } else {
            strengthBar.classList.add('strong');
            strengthText.textContent = 'Strong';
            strengthText.style.color = 'var(--success)';
        }
    });

    // --- Alerts ---
    function showAlert(message, type) {
        var iconMap = { danger: 'exclamation-circle', warning: 'exclamation-triangle', success: 'check-circle' };
        authAlert.className = 'auth-alert alert-' + type + ' show';
        authAlert.innerHTML = '<i class="fas fa-' + (iconMap[type] || 'info-circle') + '" style="margin-right:6px"></i>' + message;
    }
    function hideAlert() { authAlert.className = 'auth-alert'; authAlert.innerHTML = ''; }

    function setLoading(btn, loading) {
        var textEl = btn.querySelector('.btn-text');
        if (loading) {
            btn.disabled = true;
            btn.dataset.origText = textEl.textContent;
            textEl.innerHTML = '<span class="btn-loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span> Processing';
        } else {
            btn.disabled = false;
            textEl.textContent = btn.dataset.origText;
        }
    }

    // --- Login ---
    document.getElementById('loginForm').addEventListener('submit', function (e) {
        e.preventDefault(); hideAlert();
        var email = document.getElementById('loginEmail').value.trim();
        var password = document.getElementById('loginPassword').value;
        if (!email || !password) { showAlert('Please fill in all fields.', 'warning'); return; }
        var btn = document.getElementById('loginBtn');
        setLoading(btn, true);
        fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, password: password }) })
            .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
            .then(function (res) {
                setLoading(btn, false);
                if (res.ok && res.data.success) {
                    localStorage.setItem('access_token', res.data.access_token);
                    localStorage.setItem('user_email', email);
                    showAlert('Success! Redirecting...', 'success');
                    setTimeout(function () { window.location.href = new URLSearchParams(window.location.search).get('next') || '/'; }, 600);
                } else { showAlert(res.data.error || 'Login failed.', 'danger'); }
            })
            .catch(function () { setLoading(btn, false); showAlert('Network error. Please try again.', 'danger'); });
    });

    // --- Register ---
    document.getElementById('registerForm').addEventListener('submit', function (e) {
        e.preventDefault(); hideAlert();
        var email = document.getElementById('registerEmail').value.trim();
        var password = document.getElementById('registerPassword').value;
        var confirm = document.getElementById('registerConfirm').value;
        if (!email || !password || !confirm) { showAlert('Please fill in all fields.', 'warning'); return; }
        if (password !== confirm) { showAlert('Passwords do not match.', 'warning'); return; }
        if (password.length < 8) { showAlert('Password must be at least 8 characters.', 'warning'); return; }
        var btn = document.getElementById('registerBtn');
        setLoading(btn, true);
        fetch('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, password: password }) })
            .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
            .then(function (res) {
                setLoading(btn, false);
                if (res.ok && res.data.success) {
                    showAlert('Account created! Signing you in...', 'success');
                    fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, password: password }) })
                        .then(function (r) { return r.json(); })
                        .then(function (d) {
                            if (d.success) {
                                localStorage.setItem('access_token', d.access_token);
                                localStorage.setItem('user_email', email);
                                setTimeout(function () { window.location.href = '/'; }, 600);
                            }
                        });
                } else { showAlert(res.data.error || 'Registration failed.', 'danger'); }
            })
            .catch(function () { setLoading(btn, false); showAlert('Network error. Please try again.', 'danger'); });
    });
})();
</script>
{% endblock %}
