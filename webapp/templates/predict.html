{% extends "base.html" %}

{% block title %}Predict - Parkinson's Disease Prediction{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header + Step Indicator -->
    <div class="mb-4 fade-in-up">
        <h1 class="section-title mb-1"><i class="fas fa-chart-line" style="color:var(--accent)"></i> Prediction</h1>
        <p class="section-subtitle text-start" style="max-width:none">Select a modality, provide data, and run the AI analysis</p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator fade-in-up fade-in-up-d1" id="stepIndicator">
        <div class="step active" id="step1">
            <span class="step-num">1</span>
            <span>Select Modality</span>
        </div>
        <div class="step-line" id="stepLine1"></div>
        <div class="step" id="step2">
            <span class="step-num">2</span>
            <span>Provide Data</span>
        </div>
        <div class="step-line" id="stepLine2"></div>
        <div class="step" id="step3">
            <span class="step-num">3</span>
            <span>View Results</span>
        </div>
    </div>

    <div class="fade-in-up fade-in-up-d1">
        <div class="card" style="overflow:visible;max-width:820px;margin:0 auto">
            <div class="card-header bg-primary">
                <h5 class="mb-0"><i class="fas fa-sliders-h" style="color:var(--accent);margin-right:6px"></i> Input Data</h5>
            </div>
            <div class="card-body p-3 p-md-4">
                    <!-- Modality Tabs -->
                    <ul class="nav nav-tabs mb-3" id="modalityTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="speech-tab" data-bs-toggle="tab"
                                    data-bs-target="#speechTab" type="button" role="tab"
                                    aria-controls="speechTab" aria-selected="true">
                                <i class="fas fa-microphone" style="color:var(--accent)"></i> Speech
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="handwriting-tab" data-bs-toggle="tab"
                                    data-bs-target="#handwritingTab" type="button" role="tab"
                                    aria-controls="handwritingTab" aria-selected="false">
                                <i class="fas fa-pen" style="color:var(--success)"></i> Handwriting
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gait-tab" data-bs-toggle="tab"
                                    data-bs-target="#gaitTab" type="button" role="tab"
                                    aria-controls="gaitTab" aria-selected="false">
                                <i class="fas fa-walking" style="color:var(--warning)"></i> Gait
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="combined-tab" data-bs-toggle="tab"
                                    data-bs-target="#combinedTab" type="button" role="tab"
                                    aria-controls="combinedTab" aria-selected="false">
                                <i class="fas fa-layer-group" style="color:var(--info)"></i> Combined
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="modalityTabsContent">

                        <!-- ===== Speech Tab ===== -->
                        <div class="tab-pane fade show active" id="speechTab" role="tabpanel" aria-labelledby="speech-tab">
                            <h6 class="mb-3"><i class="fas fa-microphone" style="color:var(--accent)"></i> Speech / Audio Analysis</h6>

                            <!-- Examples -->
                            <div class="surface-card p-3 mb-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span class="icon-badge icon-badge-sm accent"><i class="fas fa-flask" style="margin:0"></i></span>
                                    <strong class="small">Try Example Data</strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success btn-sm flex-fill" id="useSpeechHealthy">
                                        <i class="fas fa-user-check"></i> Healthy
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm flex-fill" id="useSpeechPD">
                                        <i class="fas fa-user-injured"></i> PD Sample
                                    </button>
                                </div>
                            </div>

                            <div class="text-center my-3"><span class="chip">OR</span></div>

                            <!-- Voice Recording -->
                            <div class="surface-card p-3 mb-3">
                                <h6 class="small fw-bold mb-2"><i class="fas fa-record-vinyl" style="color:var(--danger)"></i> Record Your Voice</h6>
                                <p class="small mb-2" style="color:var(--text-3)">Sustain "Ahh" for 5 seconds at a comfortable pitch</p>
                                <div class="text-center mb-2">
                                    <button type="button" class="btn btn-danger" id="recordBtn">
                                        <i class="fas fa-microphone"></i> <span id="recordBtnText">Start Recording</span>
                                    </button>
                                </div>
                                <div id="recordingStatus" class="text-center mt-2" style="display:none">
                                    <div class="recording-wave mb-1">
                                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                                    </div>
                                    <small style="color:var(--danger)">Recording... Speak now!</small>
                                </div>
                            </div>

                            <div class="text-center my-3"><span class="chip">OR</span></div>

                            <!-- Audio Upload -->
                            <div class="surface-card p-3 mb-3">
                                <h6 class="small fw-bold mb-2"><i class="fas fa-cloud-upload-alt" style="color:var(--accent)"></i> Upload Audio</h6>
                                <div class="upload-zone" id="audioDropZone">
                                    <div class="upload-icon"><i class="fas fa-music"></i></div>
                                    <p>Drop audio file here or click to browse</p>
                                    <div class="upload-hint">MP3, WAV, OGG, FLAC (max 50MB)</div>
                                    <input type="file" class="form-control d-none" id="audioFileInput" accept="audio/*">
                                </div>
                                <button type="button" class="btn btn-primary btn-sm mt-2 w-100" id="uploadAudioBtn">
                                    <i class="fas fa-bolt"></i> Extract Features
                                </button>
                                <div id="audioUploadStatus" class="mt-2"></div>
                            </div>

                            <div id="speechFeatureStatus"></div>
                        </div>

                        <!-- ===== Handwriting Tab ===== -->
                        <div class="tab-pane fade" id="handwritingTab" role="tabpanel" aria-labelledby="handwriting-tab">
                            <h6 class="mb-3"><i class="fas fa-pen" style="color:var(--success)"></i> Handwriting Analysis</h6>

                            <div class="surface-card p-3 mb-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span class="icon-badge icon-badge-sm success"><i class="fas fa-flask" style="margin:0"></i></span>
                                    <strong class="small">Try Example Data</strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success btn-sm flex-fill" id="useHandwritingHealthy">
                                        <i class="fas fa-user-check"></i> Healthy
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm flex-fill" id="useHandwritingPD">
                                        <i class="fas fa-user-injured"></i> PD Sample
                                    </button>
                                </div>
                                <small class="d-block mt-2" style="color:var(--text-3)"><i class="fas fa-info-circle"></i> Enhances prediction when combined with speech</small>
                            </div>

                            <div class="text-center my-3"><span class="chip">OR</span></div>

                            <div class="alert alert-secondary small">
                                <i class="fas fa-lightbulb" style="color:var(--warning)"></i>
                                Draw a spiral or write a sentence on white paper. Take a clear photo and upload below.
                            </div>

                            <div class="surface-card p-3 mb-3">
                                <h6 class="small fw-bold mb-2"><i class="fas fa-image" style="color:var(--success)"></i> Upload Handwriting Image</h6>
                                <div class="upload-zone" id="handwritingDropZone">
                                    <div class="upload-icon"><i class="fas fa-image"></i></div>
                                    <p>Drop image here or click to browse</p>
                                    <div class="upload-hint">JPG, PNG, BMP (max 50MB)</div>
                                    <input type="file" class="form-control d-none" id="handwritingFileInput" accept="image/*">
                                </div>
                                <div id="handwritingPreview" class="mt-2 text-center" style="display:none">
                                    <img id="handwritingImg" class="img-fluid rounded" style="max-height:160px;border:1px solid var(--border)">
                                </div>
                                <button type="button" class="btn btn-success btn-sm mt-2 w-100" id="uploadHandwritingBtn">
                                    <i class="fas fa-bolt"></i> Extract Features
                                </button>
                                <div id="handwritingUploadStatus" class="mt-2"></div>
                            </div>

                            <div id="handwritingFeatureStatus"></div>
                        </div>

                        <!-- ===== Gait Tab ===== -->
                        <div class="tab-pane fade" id="gaitTab" role="tabpanel" aria-labelledby="gait-tab">
                            <h6 class="mb-3"><i class="fas fa-walking" style="color:var(--warning)"></i> Gait / Walking Analysis</h6>

                            <div class="surface-card p-3 mb-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span class="icon-badge icon-badge-sm warning"><i class="fas fa-flask" style="margin:0"></i></span>
                                    <strong class="small">Try Example Data</strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-info btn-sm flex-fill" id="useGaitHealthy">
                                        <i class="fas fa-user-check"></i> Healthy
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm flex-fill" id="useGaitPD">
                                        <i class="fas fa-user-injured"></i> PD Sample
                                    </button>
                                </div>
                                <small class="d-block mt-2" style="color:var(--text-3)"><i class="fas fa-info-circle"></i> Enhances prediction when combined with speech</small>
                            </div>

                            <div class="text-center my-3"><span class="chip">OR</span></div>

                            <div class="alert alert-secondary small">
                                <i class="fas fa-lightbulb" style="color:var(--warning)"></i>
                                Record a video of yourself walking naturally for 10-15 seconds. Side view works best.
                            </div>

                            <div class="surface-card p-3 mb-3">
                                <h6 class="small fw-bold mb-2"><i class="fas fa-video" style="color:var(--warning)"></i> Upload Walking Video</h6>
                                <div class="upload-zone" id="gaitDropZone">
                                    <div class="upload-icon"><i class="fas fa-film"></i></div>
                                    <p>Drop video here or click to browse</p>
                                    <div class="upload-hint">MP4, MOV, AVI (max 50MB)</div>
                                    <input type="file" class="form-control d-none" id="gaitFileInput" accept="video/*">
                                </div>
                                <button type="button" class="btn btn-warning btn-sm mt-2 w-100" id="uploadGaitBtn">
                                    <i class="fas fa-bolt"></i> Extract Features
                                </button>
                                <div id="gaitUploadStatus" class="mt-2"></div>
                            </div>

                            <div id="gaitFeatureStatus"></div>
                        </div>

                        <!-- ===== Combined Tab ===== -->
                        <div class="tab-pane fade" id="combinedTab" role="tabpanel" aria-labelledby="combined-tab">
                            <h6 class="mb-3"><i class="fas fa-layer-group" style="color:var(--info)"></i> Combined Video Analysis</h6>

                            <div class="surface-card p-3 mb-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span class="icon-badge icon-badge-sm info"><i class="fas fa-flask" style="margin:0"></i></span>
                                    <strong class="small">Try Example Data (All Modalities)</strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-sm flex-fill" id="useCombinedHealthy">
                                        <i class="fas fa-user-check"></i> Healthy (All)
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm flex-fill" id="useCombinedPD">
                                        <i class="fas fa-user-injured"></i> PD (All)
                                    </button>
                                </div>
                            </div>

                            <div class="text-center my-3"><span class="chip">OR</span></div>

                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle"></i>
                                Upload a single video containing speech, writing, and walking tasks.
                            </div>

                            <div class="surface-card p-3 mb-3">
                                <h6 class="small fw-bold mb-2"><i class="fas fa-video" style="color:var(--info)"></i> Upload Assessment Video</h6>
                                <div class="upload-zone" id="combinedDropZone">
                                    <div class="upload-icon"><i class="fas fa-film"></i></div>
                                    <p>Drop video here or click to browse</p>
                                    <div class="upload-hint">MP4, MOV, AVI (max 50MB)</div>
                                    <input type="file" class="form-control d-none" id="combinedVideoInput" accept="video/*">
                                </div>

                                <div class="mt-3 mb-2">
                                    <small class="fw-bold d-block mb-2" style="color:var(--text-2)">Features to extract:</small>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="extractVoiceCheck" checked>
                                        <label class="form-check-label small" for="extractVoiceCheck">
                                            <i class="fas fa-microphone" style="color:var(--accent)"></i> Voice (22 features)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="extractHandwritingCheck">
                                        <label class="form-check-label small" for="extractHandwritingCheck">
                                            <i class="fas fa-pen" style="color:var(--success)"></i> Handwriting (10 features)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="extractGaitCheck">
                                        <label class="form-check-label small" for="extractGaitCheck">
                                            <i class="fas fa-walking" style="color:var(--warning)"></i> Gait (10 features)
                                        </label>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-info btn-sm w-100" id="uploadCombinedBtn">
                                    <i class="fas fa-brain"></i> Process & Extract
                                </button>
                                <div id="combinedUploadStatus" class="mt-2"></div>
                            </div>

                            <div id="combinedFeatureStatus"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="divider pt-3 mt-3">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-accent btn-lg" id="predictBtn" disabled
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Load example data or upload a file first">
                                <i class="fas fa-play-circle"></i> Make Prediction
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="resetBtn">
                                <i class="fas fa-redo"></i> Reset All
                            </button>
                        </div>
                        <div class="text-center mt-3">
                            <small style="color:var(--text-3)">
                                <i class="fas fa-info-circle"></i> Multiple modalities improve prediction accuracy.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline Loading (below predict button) -->
    <div id="loadingSection" style="display:none" class="text-center py-4 fade-in-up">
        <div class="loader-dots mb-3">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <h6 style="color:var(--text-1)">Running AI Analysis...</h6>
        <p id="loadingText" class="small" style="color:var(--text-2)">Processing data...</p>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content results-modal-content">
            <div class="modal-header results-modal-header">
                <h5 class="modal-title" id="resultsModalLabel">
                    <i class="fas fa-chart-pie" style="color:var(--success);margin-right:6px"></i> Prediction Results
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-4">
                <div id="resultsSection">
                    <!-- Model badge -->
                    <div class="text-center mb-3" id="modelTypeBadgeContainer"></div>

                    <!-- Prediction Result -->
                    <div class="text-center mb-4" id="predictionResultArea">
                        <div id="predictionIcon" style="font-size:3.5rem;margin-bottom:.75rem"></div>
                        <h3 id="predictionLabel" class="mb-1"></h3>
                        <p id="predictionText" class="small mb-0" style="max-width:440px;margin:0 auto"></p>
                    </div>

                    <!-- Confidence Ring -->
                    <div class="text-center mb-4">
                        <div class="metric-ring" style="width:140px;height:140px;margin:0 auto">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle class="ring-track" cx="70" cy="70" r="60"/>
                                <circle class="ring-fill" id="confidenceRing" cx="70" cy="70" r="60"
                                        stroke="var(--accent)" stroke-dasharray="376.99"
                                        stroke-dashoffset="376.99"/>
                            </svg>
                            <div class="ring-label">
                                <span id="confidenceText" style="font-size:1.6rem">0%</span>
                                <span class="ring-sub">confidence</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <!-- Left column: Modalities + Probability -->
                        <div class="col-md-6">
                            <!-- Modalities Used -->
                            <div class="mb-3">
                                <small class="fw-bold d-block mb-2" style="color:var(--text-1)">Data Sources</small>
                                <div id="modalitiesUsed"></div>
                            </div>

                            <!-- Probability Bars -->
                            <div class="mb-3">
                                <small class="fw-bold d-block mb-2" style="color:var(--text-1)">Probability</small>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <small style="width:80px;color:var(--success)"><i class="fas fa-check-circle"></i> Healthy</small>
                                    <div class="flex-fill">
                                        <div class="progress" style="height:10px">
                                            <div class="progress-bar" id="healthyBar" style="width:0%;background:var(--success)"></div>
                                        </div>
                                    </div>
                                    <small id="healthyProb" class="fw-bold" style="width:60px;text-align:right;color:var(--text-1)">-</small>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <small style="width:80px;color:var(--warning)"><i class="fas fa-exclamation-triangle"></i> PD</small>
                                    <div class="flex-fill">
                                        <div class="progress" style="height:10px">
                                            <div class="progress-bar" id="pdBar" style="width:0%;background:var(--warning)"></div>
                                        </div>
                                    </div>
                                    <small id="parkinsonsProb" class="fw-bold" style="width:60px;text-align:right;color:var(--text-1)">-</small>
                                </div>
                            </div>
                        </div>

                        <!-- Right column: Model Explainability -->
                        <div class="col-md-6">
                            <!-- Model Explainability: Attention -->
                            <div id="dlAttentionSection" style="display:none">
                                <div class="dl-section-toggle" data-target="attentionContent">
                                    <h6><i class="fas fa-brain" style="color:var(--accent)"></i> Modality Attention</h6>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div id="attentionContent" class="attention-chart"></div>
                            </div>

                            <!-- Model Explainability: Feature Importance -->
                            <div id="dlFeatureImportanceSection" style="display:none">
                                <div class="dl-section-toggle" data-target="featureImportanceContent">
                                    <h6><i class="fas fa-chart-bar" style="color:var(--success)"></i> Feature Importance</h6>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div id="featureImportanceContent" class="feature-importance-section"></div>
                            </div>

                            <!-- Model Explainability: Channel Weights -->
                            <div id="dlSEWeightsSection" style="display:none">
                                <div class="dl-section-toggle" data-target="seWeightsContent">
                                    <h6><i class="fas fa-sliders-h" style="color:var(--warning)"></i> Channel Weights</h6>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div id="seWeightsContent"></div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3 small mb-0" role="alert">
                        <strong><i class="fas fa-exclamation-triangle"></i> Disclaimer:</strong>
                        For research/educational purposes only.
                    </div>
                </div>
            </div>
            <div class="modal-footer results-modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-accent" onclick="resetForm()" data-bs-dismiss="modal">
                    <i class="fas fa-redo"></i> New Prediction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Example Preview Modal -->
<div class="modal fade" id="examplePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-1)">
            <div class="modal-header" style="border-color:var(--border)">
                <h5 class="modal-title" id="exampleModalTitle">Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="examplePreviewContent"></div>
        </div>
    </div>
</div>

<!-- Hidden data storage -->
<input type="hidden" id="speechFeatures" value="">
<input type="hidden" id="handwritingFeatures" value="">
<input type="hidden" id="gaitFeatures" value="">
{% endblock %}

{% block extra_js %}
<!-- jQuery only on predict page -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="{{ url_for('static', filename='js/predict.js') }}?v=17.0"></script>
{% endblock %}
