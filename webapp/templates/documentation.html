{% extends "base.html" %}

{% block title %}Documentation - Parkinson's Disease Prediction{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4 fade-in-up">
        <h1 class="section-title"><i class="fas fa-book" style="color:var(--accent)"></i> API Documentation</h1>
        <p class="section-subtitle text-start" style="max-width:none">Complete reference for the PD Prediction API</p>
    </div>

    <!-- Overview -->
    <div class="mb-4 fade-in-up fade-in-up-d1">
        <div class="card">
            <div class="card-body p-4">
                <h3>API Overview</h3>
                <p>
                    The Parkinson's Disease Prediction API provides endpoints for making predictions
                    using advanced AI models with attention-based multimodal fusion.
                    When advanced AI models are available, predictions include explainability data (attention weights,
                    Grad-CAM feature importance, SE channel weights). All endpoints return JSON responses.
                </p>
                <p class="mb-0">
                    <strong>Base URL:</strong>
                    <code id="baseUrl"></code>
                    <button class="code-copy-btn ms-2" onclick="copyText(document.getElementById('baseUrl').textContent)" title="Copy">
                        <i class="fas fa-copy"></i>
                    </button>
                </p>
            </div>
        </div>
    </div>

    <!-- Endpoints -->
    <div class="mb-4 fade-in-up fade-in-up-d1">
        <h3 class="mb-3">API Endpoints</h3>

        <!-- Health Check -->
        <div class="card mb-3" id="ep-health">
            <div class="card-header bg-success" style="cursor:pointer" onclick="toggleEndpoint('health')">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="chip chip-success">GET</span> /api/health</h5>
                    <i class="fas fa-chevron-down toggle-icon" id="health-toggle-icon" style="transition:transform .2s;color:var(--text-3)"></i>
                </div>
            </div>
            <div class="card-body p-4" id="health-content">
                <p><strong>Description:</strong> Health check endpoint to verify API status.</p>
                <h6>Response:</h6>
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>{
  "status": "healthy",
  "active_backend": "advanced_ai",
  "models_loaded": ["speech", "handwriting", "gait"],
  "ai_model": {
    "model_type": "advanced_ai",
    "framework": "PyTorch",
    "available": true,
    "test_roc_auc": 0.95
  }
}</code></pre>
                </div>
            </div>
        </div>

        <!-- Single Prediction -->
        <div class="card mb-3" id="ep-predict">
            <div class="card-header bg-primary" style="cursor:pointer" onclick="toggleEndpoint('predict')">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="chip chip-accent">POST</span> /api/predict</h5>
                    <i class="fas fa-chevron-down toggle-icon" id="predict-toggle-icon" style="transition:transform .2s;color:var(--text-3)"></i>
                </div>
            </div>
            <div class="card-body p-4" id="predict-content">
                <p><strong>Description:</strong> Make a prediction for a single sample. At least one modality must be provided. Advanced AI models are used when available; otherwise falls back to standard machine learning.</p>

                <h6>Request:</h6>
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>{
  "speech_features": [22 float values],
  "handwriting_features": [10 float values],
  "gait_features": [10 float values]
}</code></pre>
                </div>
                <p><small style="color:var(--text-3)">All three modalities are optional. Provide at least one. Missing modalities are zero-filled internally.</small></p>

                <h6>Response (Advanced AI Model):</h6>
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>{
  "success": true,
  "prediction": 1,
  "prediction_label": "parkinsons",
  "confidence": 0.89,
  "probabilities": { "healthy": 0.11, "parkinsons": 0.89 },
  "model_type": "advanced_ai",
    "ensemble_method": "Advanced AI Model",
  "modalities_used": ["speech", "handwriting", "gait"],
  "attention_weights": {
    "speech": 0.45, "handwriting": 0.30, "gait": 0.25
  },
  "feature_importance": {
    "speech": [0.08, 0.12, ...],
    "handwriting": [0.15, 0.09, ...],
    "gait": [0.11, 0.07, ...]
  },
  "se_weights": {
    "speech": [0.6, 0.8, ...],
    "handwriting": [0.5, 0.9, ...],
    "gait": [0.7, 0.4, ...]
  },
  "feature_names": {
    "speech": ["MDVP:Fo(Hz)", "MDVP:Fhi(Hz)", ...],
    "handwriting": ["mean_pressure", ...],
    "gait": ["stride_interval", ...]
  }
}</code></pre>
                </div>
            </div>
        </div>

        <!-- Batch Prediction -->
        <div class="card mb-3" id="ep-batch">
            <div class="card-header bg-info" style="cursor:pointer" onclick="toggleEndpoint('batch')">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="chip chip-info">POST</span> /api/predict_batch</h5>
                    <i class="fas fa-chevron-down toggle-icon" id="batch-toggle-icon" style="transition:transform .2s;color:var(--text-3)"></i>
                </div>
            </div>
            <div class="card-body p-4" id="batch-content" style="display:none">
                <p><strong>Description:</strong> Batch predictions for multiple samples.</p>
                <h6>Request:</h6>
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>{
  "features": [
    [0.5, 1.2, -0.3, ...],
    [0.8, 0.6, 0.1, ...],
    ...
  ]
}</code></pre>
                </div>
                <h6>Response:</h6>
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>{
  "success": true,
  "total_samples": 2,
  "results": [
    {
      "sample_id": 0,
      "prediction": 1,
      "prediction_label": "Parkinson's Disease",
      "confidence": 0.89,
      "probabilities": { "healthy": 0.11, "parkinsons": 0.89 }
    }
  ]
}</code></pre>
                </div>
            </div>
        </div>

        <!-- Model Info -->
        <div class="card mb-3" id="ep-modelinfo">
            <div class="card-header bg-warning" style="cursor:pointer" onclick="toggleEndpoint('modelinfo')">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="chip chip-warning">GET</span> /api/model_info</h5>
                    <i class="fas fa-chevron-down toggle-icon" id="modelinfo-toggle-icon" style="transition:transform .2s;color:var(--text-3)"></i>
                </div>
            </div>
            <div class="card-body p-4" id="modelinfo-content" style="display:none">
                <p><strong>Description:</strong> Get information about the loaded models (Advanced AI and standard ML).</p>
                <h6>Response:</h6>
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>{
  "success": true,
  "active_backend": "advanced_ai",
  "ai_model": {
    "model_type": "advanced_ai",
    "framework": "PyTorch",
    "available": true,
    "test_accuracy": 0.93,
    "test_f1": 0.95,
    "test_roc_auc": 0.97,
    "total_params": 195000,
    "epochs_trained": 85
  },
  "models": { ... },
  "loaded_modalities": ["speech", "handwriting", "gait"]
}</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Examples -->
    <div class="mb-4 fade-in-up fade-in-up-d2">
        <h3 class="mb-3">Usage Examples</h3>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fab fa-python" style="color:var(--warning);margin-right:6px"></i> Python</h5>
            </div>
            <div class="card-body p-4">
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>import requests

url = "<span class="api-url-placeholder"></span>/predict"
data = {
    "speech_features": [119.99, 157.30, 74.99, ...],      # 22 values
    "handwriting_features": [0.45, 0.18, 2.2, ...],       # 10 values
    "gait_features": [1.15, 0.08, 0.38, ...]              # 10 values
}

response = requests.post(url, json=data)
result = response.json()

print(f"Prediction: {result['prediction_label']}")
print(f"Confidence: {result['confidence']:.2%}")
print(f"Model: {result.get('model_type', 'sklearn')}")
if 'attention_weights' in result:
    print(f"Attention: {result['attention_weights']}")</code></pre>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-terminal" style="color:var(--success);margin-right:6px"></i> cURL</h5>
            </div>
            <div class="card-body p-4">
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>curl -X POST <span class="api-url-placeholder"></span>/predict \
  -H "Content-Type: application/json" \
  -d '{
    "speech_features": [119.99, 157.30, 74.99, 0.00784, ...],
    "handwriting_features": [0.45, 0.18, 2.2, ...],
    "gait_features": [1.15, 0.08, 0.38, ...]
  }'</code></pre>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fab fa-js-square" style="color:var(--accent);margin-right:6px"></i> JavaScript</h5>
            </div>
            <div class="card-body p-4">
                <div style="position:relative">
                    <button class="code-copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>
                    <pre><code>fetch('<span class="api-url-placeholder"></span>/predict', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    speech_features: [119.99, 157.30, 74.99, ...],
    handwriting_features: [0.45, 0.18, 2.2, ...],
    gait_features: [1.15, 0.08, 0.38, ...]
  }),
})
.then(res => res.json())
.then(data => {
  console.log('Prediction:', data.prediction_label);
  console.log('Confidence:', data.confidence);
  console.log('Model:', data.model_type);
  if (data.attention_weights) {
    console.log('Attention:', data.attention_weights);
  }
});</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Codes -->
    <div class="fade-in-up fade-in-up-d3">
        <h3 class="mb-3">Error Codes</h3>
        <div class="card">
            <div class="card-body p-4">
                <table class="table table-bordered mb-0">
                    <thead>
                        <tr>
                            <th style="width:100px;">Code</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><code>200</code></td><td>Success &mdash; Request completed successfully</td></tr>
                        <tr><td><code>400</code></td><td>Bad Request &mdash; Invalid input data</td></tr>
                        <tr><td><code>401</code></td><td>Unauthorized &mdash; Missing or invalid JWT token</td></tr>
                        <tr><td><code>413</code></td><td>Payload Too Large &mdash; File size exceeds limit</td></tr>
                        <tr><td><code>500</code></td><td>Server Error &mdash; Model not loaded or processing error</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    'use strict';

    // Dynamic base URL
    var baseUrl = window.location.origin + '/api';
    var baseUrlEl = document.getElementById('baseUrl');
    if (baseUrlEl) baseUrlEl.textContent = baseUrl;

    // Replace all api-url-placeholder spans
    var placeholders = document.querySelectorAll('.api-url-placeholder');
    for (var i = 0; i < placeholders.length; i++) {
        placeholders[i].textContent = baseUrl;
    }

    // Collapsible endpoint sections
    window.toggleEndpoint = function (id) {
        var content = document.getElementById(id + '-content');
        var icon = document.getElementById(id + '-toggle-icon');
        if (!content) return;
        if (content.style.display === 'none') {
            content.style.display = 'block';
            if (icon) icon.style.transform = 'rotate(0deg)';
        } else {
            content.style.display = 'none';
            if (icon) icon.style.transform = 'rotate(-90deg)';
        }
    };

    // Initialize collapsed states â€” batch & modelinfo start collapsed
    var batchIcon = document.getElementById('batch-toggle-icon');
    var modelIcon = document.getElementById('modelinfo-toggle-icon');
    if (batchIcon) batchIcon.style.transform = 'rotate(-90deg)';
    if (modelIcon) modelIcon.style.transform = 'rotate(-90deg)';

    // Copy code from <pre> block
    window.copyCode = function (btn) {
        var pre = btn.closest('div').querySelector('pre');
        if (!pre) return;
        navigator.clipboard.writeText(pre.textContent).then(function () {
            var orig = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied';
            btn.style.background = 'var(--success)';
            btn.style.color = '#fff';
            btn.style.borderColor = 'var(--success)';
            setTimeout(function () {
                btn.innerHTML = orig;
                btn.style.background = '';
                btn.style.color = '';
                btn.style.borderColor = '';
            }, 1500);
        });
    };

    // Copy arbitrary text
    window.copyText = function (text) {
        navigator.clipboard.writeText(text).then(function () {
            if (typeof showNotification === 'function') {
                showNotification('Copied to clipboard!', 'success');
            }
        });
    };
})();
</script>
{% endblock %}
